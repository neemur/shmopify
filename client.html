<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Barebones Streamer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for aesthetics */
        .scrollbar-thin::-webkit-scrollbar {
            width: 8px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 20px;
            border: 2px solid #1f2937;
        }
        .tab-active {
            border-bottom: 2px solid #6366f1; /* Indigo-500 */
            color: #e5e7eb; /* Text-gray-100 */
        }
        .tab-inactive {
            color: #9ca3af; /* Text-gray-400 */
        }
        .song-row:hover {
            background-color: #374151; /* Gray-700 */
        }
        .song-row.playing {
            background-color: #4f46e5; /* Indigo-600 */
        }
        /* Style for the floating playlist dropdown */
        #playlist-dropdown-menu {
            position: absolute;
            z-index: 50; /* Above everything else */
            max-height: 200px;
            overflow-y: auto;
            transform: translate(0, -10px); /* Slightly lift it above the button */
        }
        /* Style for active playlist/library tab */
        .playlist-item.active, #library-title.active {
            border-left: 3px solid #6366f1;
            background-color: #374151; /* Gray-700 */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 font-sans">

    <script type="module">
        /* Placeholder for potential future Firebase integration */
    </script>
    
    <div id="app" class="max-w-7xl mx-auto shadow-2xl rounded-xl overflow-hidden bg-gray-800">

        <header class="p-6 bg-gray-900 border-b border-gray-700 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-indigo-400">Shmopify üéµ</h1>
            <div id="auth-status" class="text-sm">
                </div>
        </header>

        <div id="login-form" class="p-8 space-y-4 hidden transition duration-300">
            <h2 class="text-xl font-semibold text-gray-100">Access Restricted</h2>
            <p class="text-gray-400">Enter your whitelisted email to receive a secure login code.</p>
            <input type="email" id="email-input" placeholder="Email Address" class="w-full p-3 rounded-md bg-gray-700 text-gray-100 border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500">
            <button id="request-code-btn" class="w-full p-3 bg-indigo-600 hover:bg-indigo-700 rounded-md font-semibold transition duration-150">Request Login Code</button>
            <div id="code-input-area" class="space-y-4 hidden">
                <input type="text" id="code-input" placeholder="6-Digit Code" class="w-full p-3 rounded-md bg-gray-700 text-gray-100 border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500" maxlength="6">
                <button id="verify-code-btn" class="w-full p-3 bg-green-600 hover:bg-green-700 rounded-md font-semibold transition duration-150">Verify Code & Login</button>
            </div>
            <p id="auth-message" class="text-sm text-center text-red-400"></p>
        </div>

        <div id="main-content" class="flex flex-col md:flex-row h-[80vh] hidden relative"> 
            
            <aside class="w-full md:w-1/4 p-4 bg-gray-700 flex flex-col space-y-4 border-r border-gray-600">
                <h3 class="text-lg font-semibold text-gray-100">Playlists</h3>
                
                <div class="flex space-x-2 mb-4">
                    <input type="text" id="new-playlist-name" placeholder="New Playlist Name" class="flex-grow p-2 text-sm rounded-md bg-gray-800 border border-gray-600">
                    <button id="create-playlist-btn" class="p-2 bg-indigo-500 hover:bg-indigo-400 rounded-md text-sm font-medium">Create</button>
                </div>

                <div id="playlist-list" class="flex-grow space-y-2 overflow-y-auto scrollbar-thin">
                    <div id="library-link" class="p-3 bg-gray-800 hover:bg-gray-600 transition duration-150 rounded-md cursor-pointer playlist-item active">
                        <p class="text-sm font-medium">Full Library</p>
                    </div>
                    
                    <div id="playlists-container" class="space-y-2">
                        </div>
                </div>
            </aside>
            
            <main class="w-full md:w-3/4 flex flex-col">
                
                <div class="p-4 flex flex-col flex-grow">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="library-title" class="text-2xl font-semibold text-gray-100 cursor-pointer">Music Library</h3>
                    </div>
                    
                    <div class="mb-4">
                        <input type="search" id="song-search-input" placeholder="Search by Title, Artist, or Album..." class="w-full p-3 rounded-lg bg-gray-700 text-gray-100 border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <div class="grid grid-cols-12 gap-4 text-xs font-semibold uppercase text-gray-400 border-b border-gray-700 pb-2 mb-2 px-2">
                        <div class="col-span-3">Title</div>
                        <div class="col-span-4">Artist</div>
                        <div class="col-span-3">Album</div>
                        <div class="col-span-1 text-right">Time</div>
                        <div class="col-span-1 text-center">Action</div> </div>

                    <div id="song-list" class="flex-grow overflow-y-auto scrollbar-thin space-y-1">
                        <div class="text-center p-8 text-gray-500" id="loading-songs-message">Loading songs...</div>
                    </div>
                </div>

                <div id="playlist-dropdown-menu" class="hidden bg-gray-700 border border-gray-600 rounded-md shadow-lg w-48">
                    <p class="p-2 text-xs text-gray-400 border-b border-gray-600">Add to Playlist:</p>
                    <div id="dropdown-playlist-list" class="divide-y divide-gray-600">
                        </div>
                </div>

                <footer class="p-4 bg-gray-900 border-t border-gray-700 flex justify-between items-center">
                    <div id="now-playing" class="text-sm text-gray-400">
                        No song currently playing.
                    </div>
                    <audio id="audio-player" controls class="w-1/2"></audio>
                </footer>
            </main>
        </div>
    </div>


    <script>
        // Use the public server URL provided by the server environment
        const SERVER_URL = 'http://127.0.0.1:5000'; // Default to local - this gets replaced by server.py on startup!

        let currentAuthToken = localStorage.getItem('authToken');
        let currentUserId = localStorage.getItem('userId');
        let allSongs = []; // Master list of all songs from the library
        let cachedPlaylists = []; // Cache the list of user playlists
        
        // --- Global View State ---
        let currentViewSongs = []; // The list of songs currently being displayed (Library or Playlist)
        let activePlaylistId = null; // Track which playlist is active (null for library)
        
        // --- DOM Elements ---
        const authStatusElement = document.getElementById('auth-status');
        const loginFormElement = document.getElementById('login-form');
        const mainContentElement = document.getElementById('main-content');
        const emailInput = document.getElementById('email-input');
        const requestCodeBtn = document.getElementById('request-code-btn');
        const codeInputArea = document.getElementById('code-input-area');
        const codeInput = document.getElementById('code-input');
        const verifyCodeBtn = document.getElementById('verify-code-btn');
        const authMessage = document.getElementById('auth-message');
        
        const songListElement = document.getElementById('song-list');
        const audioPlayer = document.getElementById('audio-player');
        const nowPlayingElement = document.getElementById('now-playing');
        const playlistsContainer = document.getElementById('playlists-container');
        const newPlaylistNameInput = document.getElementById('new-playlist-name');
        const createPlaylistBtn = document.getElementById('create-playlist-btn');
        const songSearchInput = document.getElementById('song-search-input');
        const libraryTitleElement = document.getElementById('library-title');
        const libraryLinkElement = document.getElementById('library-link');

        const playlistDropdownMenu = document.getElementById('playlist-dropdown-menu');
        const dropdownPlaylistList = document.getElementById('dropdown-playlist-list');

        // --- Global State for Dropdown ---
        let currentDropdownSongId = null;
        let activeDropdownButton = null;


        // --- Utility Functions ---

        function getAuthHeaders(contentType = 'application/json') {
            const headers = {
                'Authorization': `Bearer ${currentAuthToken}`,
            };
            if (contentType) {
                headers['Content-Type'] = contentType;
            }
            return headers;
        }

        function formatDuration(seconds) {
            if (typeof seconds !== 'number' || isNaN(seconds)) return '0:00';
            const min = Math.floor(seconds / 60);
            const sec = seconds % 60;
            return `${min}:${sec < 10 ? '0' : ''}${sec}`;
        }
        
        function showMessage(element, message, isError = false) {
            element.textContent = message;
            element.className = isError ? 'text-sm text-center text-red-400' : 'text-sm text-center text-green-400';
        }

        /**
         * Plays a song by setting the authenticated stream URL to the audio player.
         */
        function playSong(songId, songTitle, songArtist) {
            if (!currentAuthToken) {
                showMessage(authMessage, "Please log in to stream music.", true);
                return;
            }
            
            // Remove 'playing' class from all rows
            document.querySelectorAll('.song-row').forEach(row => row.classList.remove('playing'));
            
            // Add 'playing' class to the current song's row
            const currentRow = document.querySelector(`.song-row[data-id="${songId}"]`);
            if (currentRow) {
                currentRow.classList.add('playing');
            }

            // The server uses /api/stream/<song_id> and expects the token as a query parameter.
            const streamUrl = `${SERVER_URL}/api/stream/${songId}?token=${currentAuthToken}`; 
            
            audioPlayer.src = streamUrl;
            audioPlayer.play();
            nowPlayingElement.innerHTML = `Playing: <span class="font-bold text-gray-100">${songTitle}</span> by ${songArtist}`;
        }

        // --- Auth State Management (Unchanged) ---

        function updateAuthState() {
            if (currentAuthToken && currentUserId) {
                loginFormElement.classList.add('hidden');
                mainContentElement.classList.remove('hidden');
                authStatusElement.innerHTML = `Logged in as: <span class="font-medium text-indigo-300">${currentUserId}</span> | <button id="logout-btn" class="text-red-400 hover:text-red-300 ml-2">Logout</button>`;
                
                document.getElementById('logout-btn').addEventListener('click', logout);
                
                // Fetch authenticated content
                fetchSongs();
                fetchPlaylists();
                libraryLinkElement.addEventListener('click', loadLibraryView);

            } else {
                loginFormElement.classList.remove('hidden');
                mainContentElement.classList.add('hidden');
                authStatusElement.innerHTML = 'Status: <span class="text-yellow-400">Logged Out</span>';
                codeInputArea.classList.add('hidden');
            }
        }
        
        function logout() {
            currentAuthToken = null;
            currentUserId = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('userId');
            // Clear UI elements
            songListElement.innerHTML = '';
            playlistsContainer.innerHTML = '';
            audioPlayer.src = '';
            nowPlayingElement.textContent = 'No song currently playing.';
            allSongs = [];
            cachedPlaylists = [];
            currentViewSongs = [];
            activePlaylistId = null;
            updateAuthState();
        }


        // --- Login Handlers (Unchanged) ---

        requestCodeBtn.addEventListener('click', async () => {
            const email = emailInput.value.trim();
            if (!email) {
                showMessage(authMessage, "Please enter your email address.", true);
                return;
            }
            
            requestCodeBtn.disabled = true;
            showMessage(authMessage, "Sending code...", false);

            try {
                const response = await fetch(`${SERVER_URL}/api/login/request`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage(authMessage, data.message, false);
                    codeInputArea.classList.remove('hidden');
                    codeInput.focus();
                } else {
                    showMessage(authMessage, data.error || "Failed to request code.", true);
                }
            } catch (error) {
                console.error("Network Error:", error);
                showMessage(authMessage, "Network error. Check server URL.", true);
            } finally {
                requestCodeBtn.disabled = false;
            }
        });

        verifyCodeBtn.addEventListener('click', async () => {
            const email = emailInput.value.trim();
            const code = codeInput.value.trim();
            
            if (!email || !code) {
                showMessage(authMessage, "Enter both email and code.", true);
                return;
            }
            
            verifyCodeBtn.disabled = true;
            showMessage(authMessage, "Verifying code...", false);

            try {
                const response = await fetch(`${SERVER_URL}/api/login/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, code })
                });

                const data = await response.json();

                if (response.ok) {
                    currentAuthToken = data.token;
                    currentUserId = email; // Set user ID to email as returned by server (implicit)
                    localStorage.setItem('authToken', currentAuthToken);
                    localStorage.setItem('userId', currentUserId);
                    showMessage(authMessage, "Login successful!", false);
                    updateAuthState();
                } else {
                    showMessage(authMessage, data.error || "Login failed.", true);
                }
            } catch (error) {
                console.error("Network Error:", error);
                showMessage(authMessage, "Network error. Could not verify code.", true);
            } finally {
                verifyCodeBtn.disabled = false;
            }
        });


        // --- Song View Management ---

        /**
         * Renders the filtered list of songs to the UI.
         * @param {Array<Object>} songsToRender 
         */
        function renderSongs(songsToRender) {
            songListElement.innerHTML = ''; // Clear existing list
            
            if (songsToRender.length === 0) {
                songListElement.innerHTML = `<div class="text-center p-8 text-gray-500">No songs found in this view.</div>`;
                return;
            }

            songsToRender.forEach(song => {
                const item = document.createElement('div');
                // Highlight row if it is the currently playing song (optional check if it's the right source)
                const isPlaying = audioPlayer.src.includes(song.id) && !audioPlayer.paused;
                item.className = `song-row grid grid-cols-12 gap-4 items-center text-sm p-2 rounded-md cursor-pointer transition duration-100 ${isPlaying ? 'playing' : ''}`;
                item.dataset.id = song.id;
                
                item.innerHTML = `
                    <div class="col-span-3 truncate font-medium text-gray-200">${song.title}</div>
                    <div class="col-span-4 truncate text-gray-400">${song.artist}</div>
                    <div class="col-span-3 truncate text-gray-500">${song.album}</div>
                    <div class="col-span-1 text-right text-gray-400">${formatDuration(song.duration)}</div>
                    <div class="col-span-1 text-center">
                        <button class="add-to-playlist-btn text-xs text-indigo-400 hover:text-indigo-300 font-semibold transition duration-100" 
                                data-song-id="${song.id}" 
                                data-song-title="${song.title}">
                            + Add
                        </button>
                    </div>
                `;

                item.addEventListener('click', (e) => {
                    // Prevent playing if the 'Add' button was clicked directly
                    if (e.target.closest('.add-to-playlist-btn')) return; 
                    playSong(song.id, song.title, song.artist);
                });

                songListElement.appendChild(item);
            });
            
            // Attach new event listener to all 'Add' buttons
            document.querySelectorAll('.add-to-playlist-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent the parent row's playSong handler from triggering
                    const songId = e.target.dataset.songId;
                    togglePlaylistDropdown(e.target, songId);
                });
            });
        }
        
        /**
         * Filters the currently displayed songs based on the search input.
         */
        function filterSongs() {
            const query = songSearchInput.value.trim().toLowerCase();
            const baseSongs = currentViewSongs; // Filter the songs in the current view (Library or Playlist)

            if (!query) {
                renderSongs(baseSongs);
                return;
            }

            const filtered = baseSongs.filter(song => 
                song.title.toLowerCase().includes(query) || 
                song.artist.toLowerCase().includes(query) ||
                song.album.toLowerCase().includes(query)
            );
            
            renderSongs(filtered);
        }
        
        /**
         * Fetches the full list of songs (The Library) and initializes the view.
         */
        async function fetchSongs() {
            if (!currentAuthToken) return;

            songListElement.innerHTML = `<div class="text-center p-8 text-gray-500" id="loading-songs-message">Loading library...</div>`;

            try {
                // Fetch a large limit for efficient client-side filtering (max 500)
                const response = await fetch(`${SERVER_URL}/api/songs?limit=500`, { 
                    headers: getAuthHeaders(null) 
                });
                
                if (response.ok) {
                    const data = await response.json();
                    allSongs = data.songs;
                    
                    // Initialize the view to the full library if no playlist is active
                    if (activePlaylistId === null) {
                        currentViewSongs = allSongs;
                        filterSongs(); // Render all songs initially
                    }
                } else {
                    const errorData = await response.json();
                    songListElement.innerHTML = `<div class="text-center p-8 text-red-400">Failed to load songs: ${errorData.error || response.statusText}</div>`;
                }

            } catch (error) {
                console.error("Network Error during song fetch:", error);
                songListElement.innerHTML = `<div class="text-center p-8 text-red-400">Network Error. Check console for details.</div>`;
            }
        }
        
        // --- Song Search Event Listener (Unchanged) ---
        songSearchInput.addEventListener('keyup', filterSongs);
        
        // --- Playlist View Functions ---

        /**
         * Switches the main view to the full music library.
         */
        function loadLibraryView() {
            if (activePlaylistId === null && !songSearchInput.value.trim()) return; // Already in library, no search query
            
            activePlaylistId = null;
            libraryTitleElement.textContent = 'Music Library';
            currentViewSongs = allSongs; // Reset view model to the full library
            filterSongs(); // Filter and render

            // Update sidebar visual state
            document.querySelectorAll('.playlist-item').forEach(item => item.classList.remove('active'));
            libraryLinkElement.classList.add('active');
        }

        /**
         * Switches the main view to the contents of a specific playlist.
         */
        async function loadPlaylistView(playlistId, playlistName) {
            activePlaylistId = playlistId;
            libraryTitleElement.textContent = `Playlist: ${playlistName}`;
            
            songListElement.innerHTML = `<div class="text-center p-8 text-gray-500">Loading playlist songs...</div>`;

            // Update sidebar visual state
            document.querySelectorAll('.playlist-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`.playlist-item[data-playlist-id="${playlistId}"]`).classList.add('active');


            try {
                const response = await fetch(`${SERVER_URL}/api/playlists/${playlistId}`, {
                    headers: getAuthHeaders(null),
                });

                if (response.ok) {
                    const data = await response.json();
                    currentViewSongs = data.songs; // Update the view model
                    filterSongs(); // Filter and render the new list (search query remains)
                } else {
                    const errorData = await response.json();
                    currentViewSongs = []; // Clear view
                    songListElement.innerHTML = `<div class="text-center p-8 text-red-400">Failed to load playlist: ${errorData.error || response.statusText}</div>`;
                }
            } catch (error) {
                console.error("Network Error during playlist song fetch:", error);
                songListElement.innerHTML = `<div class="text-center p-8 text-red-400">Network Error loading playlist.</div>`;
            }
        }


        // --- Playlist Dropdown Functions ---

        /**
         * Toggles the playlist dropdown menu, positioning it next to the clicked button.
         */
        async function togglePlaylistDropdown(button, songId) {
            // Hide if the same button is clicked again
            if (activeDropdownButton === button) {
                playlistDropdownMenu.classList.add('hidden');
                activeDropdownButton = null;
                currentDropdownSongId = null;
                return;
            }

            // Ensure playlists are loaded
            if (cachedPlaylists.length === 0) {
                // Fetch to populate the cache if empty
                await fetchPlaylists(false); 
            }

            // If still no playlists, inform the user
            if (cachedPlaylists.length === 0) {
                alert("You need to create a playlist first!");
                playlistDropdownMenu.classList.add('hidden');
                return;
            }

            // 1. Set global state
            currentDropdownSongId = songId;
            activeDropdownButton = button;
            
            // 2. Position the dropdown
            const buttonRect = button.getBoundingClientRect();
            const mainContentRect = mainContentElement.getBoundingClientRect();

            // Calculate position relative to the main content container
            playlistDropdownMenu.style.top = `${buttonRect.top - mainContentRect.top}px`;
            // Align to the right of the button's column
            playlistDropdownMenu.style.right = `${mainContentRect.right - buttonRect.right + buttonRect.width - 24}px`; 

            // 3. Populate and show the dropdown
            dropdownPlaylistList.innerHTML = '';
            cachedPlaylists.forEach(p => {
                const item = document.createElement('div');
                item.className = 'p-2 text-sm text-gray-200 hover:bg-indigo-600 hover:text-white transition duration-100 cursor-pointer';
                item.textContent = p.name;
                item.dataset.playlistId = p.id;
                item.addEventListener('click', () => addToPlaylist(p.id, songId, p.name));
                dropdownPlaylistList.appendChild(item);
            });

            playlistDropdownMenu.classList.remove('hidden');
        }

        /**
         * Hides the dropdown when clicking outside of it.
         */
        document.addEventListener('click', (e) => {
            if (!playlistDropdownMenu.contains(e.target) && !e.target.closest('.add-to-playlist-btn')) {
                playlistDropdownMenu.classList.add('hidden');
                activeDropdownButton = null;
                currentDropdownSongId = null;
            }
        });


        /**
         * API call to add a song to a selected playlist.
         */
        async function addToPlaylist(playlistId, songId, playlistName) {
            if (!currentAuthToken) return;

            playlistDropdownMenu.classList.add('hidden');
            activeDropdownButton = null;
            
            const originalButton = document.querySelector(`.add-to-playlist-btn[data-song-id="${songId}"]`);
            const originalButtonText = originalButton.textContent;
            originalButton.textContent = '...Adding';


            try {
                const addResponse = await fetch(`${SERVER_URL}/api/playlists/${playlistId}/add`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ song_id: songId })
                });

                const data = await addResponse.json();

                if (addResponse.ok) {
                    // Success is silent, just refresh the sidebar to update song count
                    fetchPlaylists(false); 
                    
                    // If the user is viewing the playlist being modified, update the view immediately
                    if (activePlaylistId === playlistId) {
                        loadPlaylistView(playlistId, playlistName);
                    }

                } else {
                    alert(`‚ùå Failed to add song: ${data.error || addResponse.statusText}`);
                }

            } catch (error) {
                console.error("Error adding song to playlist:", error);
                alert("A network or server error occurred.");
            } finally {
                // Restore button text
                originalButton.textContent = originalButtonText;
            }
        }


        /**
         * Fetches playlists and caches the result.
         */
        async function fetchPlaylists(showLoading = true) {
            if (!currentAuthToken) return;
            
            if (showLoading) {
                playlistsContainer.innerHTML = '<div class="text-gray-500 text-sm">Loading playlists...</div>';
            }

            try {
                const response = await fetch(`${SERVER_URL}/api/playlists`, {
                    headers: getAuthHeaders(null),
                });

                if (response.ok) {
                    const data = await response.json();
                    // Store the raw list for the dropdown
                    cachedPlaylists = data.playlists; 
                    
                    playlistsContainer.innerHTML = ''; // Clear loading message

                    if (cachedPlaylists.length === 0) {
                         playlistsContainer.innerHTML = '<div class="text-gray-500 text-sm p-2">No playlists created yet.</div>';
                         return;
                    }

                    cachedPlaylists.forEach(p => {
                        const item = document.createElement('div');
                        const isActive = activePlaylistId === p.id;
                        item.className = `p-3 bg-gray-800 hover:bg-gray-600 transition duration-150 rounded-md cursor-pointer playlist-item ${isActive ? 'active' : ''}`;
                        item.dataset.playlistId = p.id;

                        // Note: If the server API does not return song_count, it will default to 0
                        const songCount = p.song_count !== undefined ? p.song_count : 0; 
                        item.innerHTML = `<p class="text-sm font-medium">${p.name}</p><p class="text-xs text-gray-400">${songCount} songs</p>`;
                        
                        item.addEventListener('click', () => loadPlaylistView(p.id, p.name));
                        
                        playlistsContainer.appendChild(item);
                    });
                    
                    // Re-apply active class to Library link (if needed)
                    if (activePlaylistId === null) {
                        libraryLinkElement.classList.add('active');
                    }
                    
                } else {
                    const data = await response.json();
                    console.error("Fetch Playlists Failed:", data.error);
                    playlistsContainer.innerHTML = `<div class="text-red-400 text-sm p-2">Error loading playlists.</div>`;
                }
            } catch (error) {
                console.error("Network Error during playlist fetch:", error);
                playlistsContainer.innerHTML = `<div class="text-red-400 text-sm p-2">Network Error.</div>`;
            }
        }

        createPlaylistBtn.addEventListener('click', async () => {
            if (!currentAuthToken) return;
            const name = newPlaylistNameInput.value.trim();
            if (!name) return;

            try {
                createPlaylistBtn.disabled = true;
                const response = await fetch(`${SERVER_URL}/api/playlists`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ name })
                });

                if (response.ok) {
                    const data = await response.json();
                    newPlaylistNameInput.value = '';
                    fetchPlaylists(); // Refresh both the list and the cache
                    // Switch to the newly created playlist view
                    loadPlaylistView(data.id, name);
                } else {
                    const data = await response.json();
                    console.error("Create Playlist Failed:", data.error);
                    alert(`Failed to create playlist: ${data.error}`);
                }
            } catch (error) {
                console.error("Network Error:", error);
            } finally {
                createPlaylistBtn.disabled = false;
            }
        });


        // --- Initialization ---

        // Must call updateAuthState on load to check for existing token
        updateAuthState();
    </script>
</body>
</html>

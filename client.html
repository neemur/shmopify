<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Barebones Streamer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .scrollbar-thin::-webkit-scrollbar { width: 8px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #1f2937; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 20px; border: 2px solid #1f2937; }
        .song-row:hover { background-color: #374151; }
        .song-row.playing { background-color: #4f46e5; }
        .playlist-item.active, #library-title.active { border-left: 3px solid #6366f1; background-color: #374151; }
        #playlist-dropdown-menu { position: absolute; z-index: 50; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 h-screen font-sans overflow-hidden flex flex-col">

    <script type="module">
        /* Placeholder for potential future Firebase integration */
    </script>
    
    <div id="app" class="w-full h-full flex flex-col bg-gray-800">

        <header class="p-6 bg-gray-900 border-b border-gray-700 flex justify-between items-center shrink-0">
            <h1 class="text-3xl font-bold text-indigo-400">Shmopify ðŸŽµ</h1>
            <div id="auth-status" class="text-sm"></div>
        </header>

        <div id="login-form" class="flex-grow flex flex-col justify-center items-center hidden transition duration-300 p-4">
            <div class="bg-gray-800 p-8 rounded-lg shadow-lg w-full max-w-md border border-gray-700">
                <h2 class="text-xl font-semibold text-gray-100 mb-2">Access Restricted</h2>
                <p class="text-gray-400 mb-4">Enter your whitelisted email for a 1-week session.</p>
                <input type="email" id="email-input" placeholder="Email Address" class="w-full p-3 rounded-md bg-gray-700 text-gray-100 border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500 mb-4">
                <button id="request-code-btn" class="w-full p-3 bg-indigo-600 hover:bg-indigo-700 rounded-md font-semibold transition duration-150 mb-4">Request Login Code</button>
                
                <div id="code-input-area" class="space-y-4 hidden">
                    <input type="text" id="code-input" placeholder="6-Digit Code" class="w-full p-3 rounded-md bg-gray-700 text-gray-100 border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500" maxlength="6">
                    <button id="verify-code-btn" class="w-full p-3 bg-green-600 hover:bg-green-700 rounded-md font-semibold transition duration-150">Verify & Login</button>
                </div>
                <p id="auth-message" class="text-sm text-center text-red-400 mt-2 min-h-[20px]"></p>
            </div>
        </div>

        <div id="main-content" class="flex-grow flex flex-col md:flex-row overflow-hidden hidden relative"> 
            
            <aside class="w-full md:w-1/4 bg-gray-700 flex flex-col border-r border-gray-600 overflow-hidden">
                <div class="p-4 space-y-4 shrink-0">
                    <h3 class="text-lg font-semibold text-gray-100">Library Tools</h3>
                    
                    <div id="upload-section" class="space-y-2 p-3 bg-gray-800 rounded-md">
                        <h4 class="text-md font-semibold text-gray-100">Upload Music</h4>
                        <input type="file" id="music-file-input" accept=".mp3, .m4a, .flac, .ogg" class="text-sm w-full text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                        <button id="upload-music-btn" class="w-full p-2 bg-green-600 hover:bg-green-700 rounded-md text-sm font-medium disabled:opacity-50" disabled>Upload Song</button>
                        <p id="upload-message" class="text-xs text-center text-gray-400"></p>
                    </div>

                    <div class="space-y-2">
                        <input type="text" id="new-playlist-name" placeholder="New Playlist Name" class="w-full p-2 text-sm rounded-md bg-gray-800 border border-gray-600">
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="new-playlist-public" class="rounded bg-gray-800 border-gray-600 text-indigo-500 focus:ring-indigo-500">
                            <label for="new-playlist-public" class="text-xs text-gray-400">Make Public</label>
                            <button id="create-playlist-btn" class="ml-auto p-1 px-3 bg-indigo-500 hover:bg-indigo-400 rounded-md text-sm font-medium">Create</button>
                        </div>
                    </div>
                </div>

                <div class="flex-grow overflow-y-auto scrollbar-thin p-4 pt-0 space-y-2">
                    <div id="library-link" class="p-3 bg-gray-800 hover:bg-gray-600 transition duration-150 rounded-md cursor-pointer playlist-item active">
                        <p class="text-sm font-medium">Full Library</p>
                    </div>
                    
                    <div id="playlists-container" class="space-y-2"></div>
                </div>
            </aside>
            
            <main class="w-full md:w-3/4 flex flex-col overflow-hidden bg-gray-800">
                
                <div class="p-4 shrink-0">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="library-title" class="text-2xl font-semibold text-gray-100 cursor-pointer">Music Library</h3>
                        <div id="playlist-meta" class="text-xs text-gray-400 text-right hidden"></div>
                    </div>
                    
                    <div class="mb-4">
                        <input type="search" id="song-search-input" placeholder="Search by Title, Artist, or Album..." class="w-full p-3 rounded-lg bg-gray-700 text-gray-100 border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <div class="grid grid-cols-12 gap-4 text-xs font-semibold uppercase text-gray-400 border-b border-gray-700 pb-2 px-2">
                        <div class="col-span-3">Title</div>
                        <div class="col-span-4">Artist</div>
                        <div class="col-span-3">Album</div>
                        <div class="col-span-1 text-right">Time</div>
                        <div class="col-span-1 text-center">Action</div> 
                    </div>
                </div>

                <div id="song-list" class="flex-grow overflow-y-auto scrollbar-thin px-4 pb-4 space-y-1">
                    <div class="text-center p-8 text-gray-500" id="loading-songs-message">Loading songs...</div>
                </div>
            </main>
        </div>

        <div id="playlist-dropdown-menu" class="hidden bg-gray-700 border border-gray-600 rounded-md shadow-lg w-48">
            <p class="p-2 text-xs text-gray-400 border-b border-gray-600">Add to Playlist:</p>
            <div id="dropdown-playlist-list" class="divide-y divide-gray-600"></div>
        </div>

        <footer class="p-4 bg-gray-900 border-t border-gray-700 flex justify-between items-center shrink-0 z-10">
            <div id="now-playing" class="text-sm text-gray-400">
                No song currently playing.
            </div>
            <audio id="audio-player" controls class="w-1/2"></audio>
        </footer>
    </div>


    <script>
        const SERVER_URL = 'http://127.0.0.1:5000'; 

        let currentAuthToken = localStorage.getItem('authToken');
        let currentUserId = localStorage.getItem('userId');
        let allSongs = []; 
        let cachedPlaylists = []; 
        
        let currentViewSongs = []; 
        let activePlaylistId = null; 
        
        // --- DOM Elements ---
        const authStatusElement = document.getElementById('auth-status');
        const loginFormElement = document.getElementById('login-form');
        const mainContentElement = document.getElementById('main-content');
        const emailInput = document.getElementById('email-input');
        const requestCodeBtn = document.getElementById('request-code-btn');
        const codeInputArea = document.getElementById('code-input-area');
        const codeInput = document.getElementById('code-input');
        const verifyCodeBtn = document.getElementById('verify-code-btn');
        const authMessage = document.getElementById('auth-message');
        
        const songListElement = document.getElementById('song-list');
        const audioPlayer = document.getElementById('audio-player');
        const nowPlayingElement = document.getElementById('now-playing');
        const playlistsContainer = document.getElementById('playlists-container');
        const newPlaylistNameInput = document.getElementById('new-playlist-name');
        const newPlaylistPublicInput = document.getElementById('new-playlist-public'); // New Checkbox
        const createPlaylistBtn = document.getElementById('create-playlist-btn');
        const songSearchInput = document.getElementById('song-search-input');
        const libraryTitleElement = document.getElementById('library-title');
        const libraryLinkElement = document.getElementById('library-link');
        const playlistMetaElement = document.getElementById('playlist-meta');

        const playlistDropdownMenu = document.getElementById('playlist-dropdown-menu');
        const dropdownPlaylistList = document.getElementById('dropdown-playlist-list');

        const musicFileInput = document.getElementById('music-file-input');
        const uploadMusicBtn = document.getElementById('upload-music-btn');
        const uploadMessage = document.getElementById('upload-message');

        let currentDropdownSongId = null;
        let activeDropdownButton = null;

        // --- Utility ---

        function getAuthHeaders(contentType = 'application/json') {
            const headers = { 'Authorization': `Bearer ${currentAuthToken}` };
            if (contentType) headers['Content-Type'] = contentType;
            return headers;
        }

        function formatDuration(seconds) {
            if (typeof seconds !== 'number' || isNaN(seconds)) return '0:00';
            const min = Math.floor(seconds / 60);
            const sec = seconds % 60;
            return `${min}:${sec < 10 ? '0' : ''}${sec}`;
        }
        
        function showMessage(element, message, isError = false) {
            element.textContent = message;
            element.className = isError ? 'text-sm text-center text-red-400 mt-2' : 'text-sm text-center text-green-400 mt-2';
        }

        async function apiCall(url, options = {}) {
            const response = await fetch(url, options);
            if (response.status === 401) {
                // Token invalid or expired
                logout();
                throw new Error("Session expired");
            }
            return response;
        }

        function playSong(songId, songTitle, songArtist) {
            if (!currentAuthToken) return;
            document.querySelectorAll('.song-row').forEach(row => row.classList.remove('playing'));
            const currentRow = document.querySelector(`.song-row[data-id="${songId}"]`);
            if (currentRow) currentRow.classList.add('playing');
            
            const streamUrl = `${SERVER_URL}/api/stream/${songId}?token=${currentAuthToken}`; 
            audioPlayer.src = streamUrl;
            audioPlayer.play();
            nowPlayingElement.innerHTML = `Playing: <span class="font-bold text-gray-100">${songTitle}</span> by ${songArtist}`;
        }

        // --- Auth ---

        function updateAuthState() {
            if (currentAuthToken && currentUserId) {
                loginFormElement.classList.add('hidden');
                mainContentElement.classList.remove('hidden');
                authStatusElement.innerHTML = `User: <span class="font-medium text-indigo-300">${currentUserId}</span> | <button id="logout-btn" class="text-red-400 hover:text-red-300 ml-2">Logout</button>`;
                document.getElementById('logout-btn').addEventListener('click', logout);
                
                fetchSongs();
                fetchPlaylists();
                libraryLinkElement.addEventListener('click', loadLibraryView);
                musicFileInput.addEventListener('change', () => uploadMusicBtn.disabled = musicFileInput.files.length === 0);
                uploadMusicBtn.addEventListener('click', handleUploadClick);

            } else {
                loginFormElement.classList.remove('hidden');
                mainContentElement.classList.add('hidden');
                authStatusElement.innerHTML = '<span class="text-yellow-400">Logged Out</span>';
                codeInputArea.classList.add('hidden');
            }
        }
        
        function logout() {
            currentAuthToken = null;
            currentUserId = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('userId');
            songListElement.innerHTML = '';
            playlistsContainer.innerHTML = '';
            audioPlayer.src = '';
            updateAuthState();
        }

        // --- Login Handlers ---

        requestCodeBtn.addEventListener('click', async () => {
            const email = emailInput.value.trim();
            if (!email) return showMessage(authMessage, "Enter email address.", true);
            
            requestCodeBtn.disabled = true;
            try {
                const response = await fetch(`${SERVER_URL}/api/login/request`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email })
                });
                const data = await response.json();
                if (response.ok) {
                    showMessage(authMessage, data.message, false);
                    codeInputArea.classList.remove('hidden');
                } else {
                    showMessage(authMessage, data.error, true);
                }
            } catch (error) {
                showMessage(authMessage, "Network error.", true);
            } finally {
                requestCodeBtn.disabled = false;
            }
        });

        verifyCodeBtn.addEventListener('click', async () => {
            const email = emailInput.value.trim();
            const code = codeInput.value.trim();
            if (!email || !code) return;
            
            verifyCodeBtn.disabled = true;
            try {
                const response = await fetch(`${SERVER_URL}/api/login/verify`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, code })
                });
                const data = await response.json();
                if (response.ok) {
                    currentAuthToken = data.token;
                    currentUserId = email; 
                    localStorage.setItem('authToken', currentAuthToken);
                    localStorage.setItem('userId', currentUserId);
                    updateAuthState();
                } else {
                    showMessage(authMessage, data.error, true);
                }
            } catch (error) {
                showMessage(authMessage, "Network error.", true);
            } finally {
                verifyCodeBtn.disabled = false;
            }
        });

        // --- Song View ---

        function renderSongs(songsToRender, canRemove = false) {
            songListElement.innerHTML = ''; 
            if (songsToRender.length === 0) {
                songListElement.innerHTML = `<div class="text-center p-8 text-gray-500">No songs found.</div>`;
                return;
            }

            songsToRender.forEach(song => {
                const item = document.createElement('div');
                const isPlaying = audioPlayer.src.includes(song.id) && !audioPlayer.paused;
                item.className = `song-row grid grid-cols-12 gap-4 items-center text-sm p-2 rounded-md cursor-pointer transition duration-100 ${isPlaying ? 'playing' : ''}`;
                item.dataset.id = song.id;
                
                // Add/Remove button logic
                let actionBtnHTML = `<button class="add-to-playlist-btn text-xs text-indigo-400 hover:text-indigo-300 font-semibold" data-id="${song.id}">+ Add</button>`;
                if (canRemove) {
                    actionBtnHTML = `<button class="remove-from-playlist-btn text-xs text-red-400 hover:text-red-300 font-semibold" data-id="${song.id}">- Remove</button>`;
                }

                item.innerHTML = `
                    <div class="col-span-3 truncate font-medium text-gray-200">${song.title}</div>
                    <div class="col-span-4 truncate text-gray-400">${song.artist}</div>
                    <div class="col-span-3 truncate text-gray-500">${song.album}</div>
                    <div class="col-span-1 text-right text-gray-400">${formatDuration(song.duration)}</div>
                    <div class="col-span-1 text-center">${actionBtnHTML}</div>
                `;

                item.addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON') return; 
                    playSong(song.id, song.title, song.artist);
                });

                songListElement.appendChild(item);
            });
            
            // Attach Events
            document.querySelectorAll('.add-to-playlist-btn').forEach(btn => {
                btn.addEventListener('click', (e) => togglePlaylistDropdown(e.target, e.target.dataset.id));
            });
            
            if (canRemove) {
                document.querySelectorAll('.remove-from-playlist-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => removeFromPlaylist(e.target.dataset.id));
                });
            }
        }
        
        function filterSongs() {
            const query = songSearchInput.value.trim().toLowerCase();
            const baseSongs = currentViewSongs;
            if (!query) {
                // If viewing a playlist and it belongs to current user, allow removal
                const isOwner = activePlaylistId && cachedPlaylists.find(p => p.id === activePlaylistId)?.user_email === currentUserId;
                renderSongs(baseSongs, isOwner); 
                return;
            }
            const filtered = baseSongs.filter(song => 
                song.title.toLowerCase().includes(query) || 
                song.artist.toLowerCase().includes(query) ||
                song.album.toLowerCase().includes(query)
            );
            // Don't show remove buttons during search to simplify logic
            renderSongs(filtered, false); 
        }
        
        async function fetchSongs() {
            if (!currentAuthToken) return;
            songListElement.innerHTML = `<div class="text-center p-8 text-gray-500">Loading library...</div>`;
            try {
                const response = await apiCall(`${SERVER_URL}/api/songs?limit=500`, { headers: getAuthHeaders(null) });
                if (response.ok) {
                    const data = await response.json();
                    allSongs = data.songs;
                    if (activePlaylistId === null) {
                        currentViewSongs = allSongs;
                        filterSongs();
                    }
                }
            } catch (e) { console.error(e); }
        }
        
        songSearchInput.addEventListener('keyup', filterSongs);
        libraryTitleElement.addEventListener('click', loadLibraryView);

        // --- Playlist View ---

        function loadLibraryView() {
            if (activePlaylistId === null && !songSearchInput.value.trim()) return;
            activePlaylistId = null;
            libraryTitleElement.textContent = 'Music Library';
            playlistMetaElement.classList.add('hidden');
            currentViewSongs = allSongs;
            filterSongs();
            document.querySelectorAll('.playlist-item').forEach(item => item.classList.remove('active'));
            libraryLinkElement.classList.add('active');
        }

        async function loadPlaylistView(playlistId, playlistName) {
            activePlaylistId = playlistId;
            libraryTitleElement.textContent = `Playlist: ${playlistName}`;
            songListElement.innerHTML = `<div class="text-center p-8 text-gray-500">Loading playlist...</div>`;
            
            document.querySelectorAll('.playlist-item').forEach(item => item.classList.remove('active'));
            const activeItem = document.querySelector(`.playlist-item[data-playlist-id="${playlistId}"]`);
            if (activeItem) activeItem.classList.add('active');

            try {
                const response = await apiCall(`${SERVER_URL}/api/playlists/${playlistId}`, { headers: getAuthHeaders(null) });
                if (response.ok) {
                    const data = await response.json();
                    currentViewSongs = data.songs;
                    
                    // Show metadata for public playlists
                    if (data.creator !== currentUserId) {
                        playlistMetaElement.innerHTML = `Created by: ${data.creator} <br> on ${data.created_at}`;
                        playlistMetaElement.classList.remove('hidden');
                        renderSongs(currentViewSongs, false); // Cannot remove from others' playlists
                    } else {
                        playlistMetaElement.classList.add('hidden');
                        renderSongs(currentViewSongs, true); // Owner can remove
                    }
                    
                } else {
                    currentViewSongs = [];
                    songListElement.innerHTML = `<div class="text-center text-red-400">Error loading playlist.</div>`;
                }
            } catch (e) { console.error(e); }
        }

        async function removeFromPlaylist(songId) {
            if (!activePlaylistId) return;
            if(!confirm("Remove song from playlist?")) return;

            try {
                const response = await apiCall(`${SERVER_URL}/api/playlists/${activePlaylistId}/remove`, {
                    method: 'POST', headers: getAuthHeaders(), body: JSON.stringify({ song_id: songId })
                });
                if (response.ok) {
                    // Update Local State
                    currentViewSongs = currentViewSongs.filter(s => s.id !== songId);
                    renderSongs(currentViewSongs, true);
                    fetchPlaylists(false); // Update sidebar count
                }
            } catch (e) { console.error(e); }
        }

        // --- Playlist Actions ---

        async function togglePlaylistDropdown(button, songId) {
            if (activeDropdownButton === button) {
                playlistDropdownMenu.classList.add('hidden');
                activeDropdownButton = null;
                return;
            }
            if (cachedPlaylists.length === 0) await fetchPlaylists(false);

            // Filter for only OWNED playlists for the "Add to" dropdown
            const myPlaylists = cachedPlaylists.filter(p => p.user_email === currentUserId);

            if (myPlaylists.length === 0) {
                alert("Create a playlist first!");
                return;
            }

            currentDropdownSongId = songId;
            activeDropdownButton = button;
            
            const buttonRect = button.getBoundingClientRect();
            // We use fixed positioning relative to the viewport because of overflow:hidden on parents
            playlistDropdownMenu.style.position = 'fixed';
            playlistDropdownMenu.style.top = `${buttonRect.bottom + 5}px`;
            playlistDropdownMenu.style.left = `${buttonRect.left - 150}px`; // Shift left to keep on screen
            
            dropdownPlaylistList.innerHTML = '';
            myPlaylists.forEach(p => {
                const item = document.createElement('div');
                item.className = 'p-2 text-sm text-gray-200 hover:bg-indigo-600 cursor-pointer';
                item.textContent = p.name;
                item.addEventListener('click', () => addToPlaylist(p.id, songId, p.name));
                dropdownPlaylistList.appendChild(item);
            });

            playlistDropdownMenu.classList.remove('hidden');
        }

        document.addEventListener('click', (e) => {
            if (!playlistDropdownMenu.contains(e.target) && !e.target.closest('.add-to-playlist-btn')) {
                playlistDropdownMenu.classList.add('hidden');
                activeDropdownButton = null;
            }
        });

        async function addToPlaylist(playlistId, songId) {
            playlistDropdownMenu.classList.add('hidden');
            try {
                const response = await apiCall(`${SERVER_URL}/api/playlists/${playlistId}/add`, {
                    method: 'POST', headers: getAuthHeaders(), body: JSON.stringify({ song_id: songId })
                });
                if (response.ok) {
                    fetchPlaylists(false); 
                    if (activePlaylistId === playlistId) loadPlaylistView(playlistId, ""); 
                }
            } catch (e) { console.error(e); }
        }

        async function fetchPlaylists(showLoading = true) {
            if (!currentAuthToken) return;
            if (showLoading) playlistsContainer.innerHTML = '<div class="text-gray-500 text-sm">Loading...</div>';
            try {
                const response = await apiCall(`${SERVER_URL}/api/playlists`, { headers: getAuthHeaders(null) });
                if (response.ok) {
                    const data = await response.json();
                    cachedPlaylists = data.playlists;
                    playlistsContainer.innerHTML = '';
                    
                    if (cachedPlaylists.length === 0) {
                         playlistsContainer.innerHTML = '<div class="text-gray-500 text-sm p-2">No playlists.</div>';
                         return;
                    }

                    cachedPlaylists.forEach(p => {
                        const item = document.createElement('div');
                        const isActive = activePlaylistId === p.id;
                        const isPublic = p.is_public === 1;
                        const isMine = p.user_email === currentUserId;
                        
                        let badge = '';
                        if (isPublic && isMine) badge = '<span class="text-[10px] bg-indigo-900 text-indigo-300 px-1 rounded ml-2">Public</span>';
                        if (isPublic && !isMine) badge = '<span class="text-[10px] bg-green-900 text-green-300 px-1 rounded ml-2">Community</span>';

                        item.className = `p-3 bg-gray-800 hover:bg-gray-600 transition duration-150 rounded-md cursor-pointer playlist-item ${isActive ? 'active' : ''}`;
                        item.dataset.playlistId = p.id;
                        item.innerHTML = `
                            <div class="flex justify-between items-center">
                                <p class="text-sm font-medium truncate">${p.name}</p>
                                ${badge}
                            </div>
                            <p class="text-xs text-gray-400">${p.song_count || 0} songs ${!isMine ? 'â€¢ by ' + p.user_email.split('@')[0] : ''}</p>
                        `;
                        item.addEventListener('click', () => loadPlaylistView(p.id, p.name));
                        playlistsContainer.appendChild(item);
                    });
                    if (activePlaylistId === null) libraryLinkElement.classList.add('active');
                }
            } catch (e) { console.error(e); }
        }

        createPlaylistBtn.addEventListener('click', async () => {
            const name = newPlaylistNameInput.value.trim();
            const isPublic = newPlaylistPublicInput.checked;
            if (!name) return;
            createPlaylistBtn.disabled = true;
            try {
                const response = await apiCall(`${SERVER_URL}/api/playlists`, {
                    method: 'POST', headers: getAuthHeaders(), body: JSON.stringify({ name, is_public: isPublic })
                });
                if (response.ok) {
                    const data = await response.json();
                    newPlaylistNameInput.value = '';
                    newPlaylistPublicInput.checked = false;
                    fetchPlaylists(); 
                    loadPlaylistView(data.id, name);
                }
            } catch (e) { console.error(e); }
            finally { createPlaylistBtn.disabled = false; }
        });

        // --- Upload ---
        async function handleUploadClick() {
            const file = musicFileInput.files[0];
            if (!file) return;
            uploadMusicBtn.disabled = true;
            uploadMessage.textContent = "Uploading...";
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${SERVER_URL}/api/upload`, {
                    method: 'POST', headers: { 'Authorization': `Bearer ${currentAuthToken}` }, body: formData
                });
                if (response.ok) {
                    uploadMessage.textContent = "Done!";
                    musicFileInput.value = ''; 
                    fetchSongs(); 
                } else {
                    uploadMessage.textContent = "Error.";
                }
            } catch (e) { console.error(e); }
            finally { 
                if(musicFileInput.files.length > 0) uploadMusicBtn.disabled = false; 
                setTimeout(() => uploadMessage.textContent = '', 3000);
            }
        }

        updateAuthState();
    </script>
</body>
</html>
